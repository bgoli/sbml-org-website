#!/bin/bash
# ============================================================================
# File name   : pre-commit
# Description : git pre-commit hook to save a version number on every commit
# Author(s)   : Michael Hucka <mhucka@caltech.edu>
# Organization: California Institute of Technology
# Date created: 2020-05-04
#
# This hook and the companion post-commit hook need to be installed in your
# local copy of the repository.  One way to do that is to configure git to
# look for hooks in a local directory:
#
#   git config core.hooksPath .githooks
#
# ============================================================================

root=$(git rev-parse --show-toplevel)
count=$(git rev-list HEAD --count)
branch=$(git branch --show-current)
identifier=$(git describe --always --tags --dirty="-local")
timestamp=$(git log -1 --date=format:"%Y-%m-%d %T" --format="%ai")

versionfile=$root/site/data/site.toml

cat <<EOF > $versionfile
# =============================================================================
# File name   : /data/site.toml
# Description : Data file for site data
# Author(s)   : Michael Hucka <mhucka@caltech.edu>
# Organization: California Institute of Technology
#
#   ,---------------------- Notice -- Notice -- Notice ----------------------.
#   |                                                                        |
#   |                         Do not edit this file.                         |
#   |                                                                        |
#   |      THIS FILE IS AUTOMATICALLY REGENERATED UPON EVERY GIT COMMIT.     |
#   |                                                                        |
#   `---------------------- Notice -- Notice -- Notice ----------------------'
#
# See the explanation in the file .githooks/README.md in the top level of the
# repository.  The pre-commit and post-commit hooks need to be installed in
# your local copy of the repository if you want to commit any changes to the
# repository.  One way to do that is to configure git like this:
#
#   git config core.hooksPath .githooks
#
# =============================================================================

commit_count = "$count"
identifier = "$identifier"
revision = "$commit_count ($identifier on $branch)"
timestamp = $timestamp
EOF

git add $versionfile
touch $versionfile.needcommit
