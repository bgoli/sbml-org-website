#!/bin/bash
# ============================================================================
# File name   : post-merge
# Description : git post hook to save a version number
# Author(s)   : Michael Hucka <mhucka@caltech.edu>
# Organization: California Institute of Technology
# Date created: 2020-05-04
#
# Please read the information in the README.md in the .githooks directory
# where this file is located.
# ============================================================================

root=$(git rev-parse --show-toplevel)
count=$(git rev-list HEAD --count)
branch=$(git rev-parse --abbrev-ref HEAD)
identifier=$(git describe --always --tags --dirty="-local")
timestamp=$(git log -1 --date=format:"%Y-%m-%d %T" --format="%ai")

versionfile=$root/site/data/site.toml

cat <<EOF > $versionfile
# =============================================================================
# File name   : /data/site.toml
# Description : Data file for site data
#
#   ╭────────────────────── Notice ── Notice ── Notice ──────────────────────╮
#   │                                                                        │
#   │                          Do not edit this file.                        │
#   │                                                                        │
#   │      THIS FILE IS AUTOMATICALLY REGENERATED UPON EVERY GIT COMMIT.     │
#   │                                                                        │
#   ╰────────────────────── Notice ── Notice ── Notice ──────────────────────╯
#
# Please see the explanation in the file .githooks/README.md in the top level
# of the repository.  The post-commit, post-merge and post-rewrite hooks need
# to be installed in your local copy of the repo if you want the file
# /site/data/site.toml to be updated locally when you commit changes.  One
# way to do that is to configure git like this:
#
#   git config core.hooksPath .githooks
#
# =============================================================================

commit_count = "$count"
identifier = "$identifier"
revision = "$count ($identifier on branch $branch)"
timestamp = "$timestamp"
EOF
