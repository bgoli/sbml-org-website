<!-- ==========================================================================
File name   : /layouts/shortcodes/sbml-spec-box.html
Description : Shortcode for creating a box describing a given spec in detail
Author(s)   : Michael Hucka <mhucka@caltech.edu>
Organization: California Institute of Technology
Date created: 2020-03-09

This shortcode expects to be called with arguments like in this example:

  sbml-spec-box  package="core"  level="3"  version="2"  release="2"

The code below is tightly coupled to the structure of the data subdirectory
/data/SBML/specs/.  In Hugo, the /data directory is like a mini hierarchical
database, and the values are accessible by using "index" and dotted notation
to traverse paths.  In our /data subdirectory, there are nested subdirectories
for every SBML Core and Package specification.  Here's a portion:

     ├── comp
     │   └── level3
     │       └── version1
     │           ├── release1.toml
     │           ├── release2.toml
     │           └── release3.toml
     ├── core
     │   ├── level1
     │   ├── level2
     │   │   ├── version1
     │   │   │   └── release1.toml
     │   │   ├── version2
     │   │   │   └── release1.toml
     │   │   ├── version3
     │   │   │   ├── release1.toml
     │   │   │   └── release2.toml
     │   │   ├── version4
     │   │   │   └── release1.toml
     │   │   └── version5
     │   │       └── release1.toml
     │   └── level3
     │       ├── version1
     │       └── version2
     │           ├── release1.toml
     │           └── release2.toml
     ...

The TOML files at the leaves of the directory tree contain data about each
specification.  The parameters for this Hugo shortcode are converted to 
subdirectory names, which are then used with the Hugo "index" function to
read the appropriate .toml data file.
=========================================================================== -->

<!-- Assign arguments to internal variables. -->
{{ $package  := ( .Get "package" ) }}
{{ $level    := ( .Get "level" ) }}
{{ $version  := ( .Get "version" ) }}
{{ $release  := ( .Get "release" )  | default "none" }}
{{ $revision := ( .Get "revision" ) | default "none" }}

<!-- Convert argument values like "3" into "level3", for use below. -->
{{ $level_key    := print "sbml-level-" $level }} 
{{ $version_key  := print "version-"    $version }}    
{{ $release_key  := print "release-"    $release }}    
{{ $revision_key := print "revision-"   $revision }}
                                                    
<!-- Get array of all level/version/release data for this package. -->
{{ $package_data := index .Site.Data.SBML.specs $package }}

<!-- Initialize some variables. (I'm not actually sure why I get runtime errors
     about undefined variables unless these are set to something.  The if-then 
     conditional right below this has no exit: one of the cases must be true 
     and the values of the variables must be set.  Yet without setting $spec 
     to something here, accessing it in the HTML code below produces errors.  
     I'm stumped but I don't have more time to figure out what's really going
     on.  Let's just set them to something and more along.) -->
{{ $spec := "" }}
{{ $rel_text := "" }}

<!-- Drill down to get the entry for the desired release (or in the case
     of SBML Level 2 Version 1, the revision, as it was known then). -->
{{ $all_versions := ( index $package_data $level_key ) }}
{{ if and (ne $revision "") (ne $revision "none") }}
  {{ $all_revisions := ( index $all_versions $version_key ) }}
  {{ $spec = ( index $all_revisions $revision_key ) }}
  {{ $rel_text = print "Revision " $spec.revision }}
{{ else if eq $release "none" }}
  {{ $spec = ( index $all_versions $version_key ) }}
  {{ $rel_text = "" }}
{{ else }}
  {{ $all_releases  := ( index $all_versions $version_key ) }}
  {{ $spec = ( index $all_releases $release_key ) }}
  {{ $rel_text = print "Release " $spec.release }}
{{ end }}

<!-- Finally, generate the output that is put on the page. -->
<div class="sbml-spec-box">
  <div class="sbml-spec-tag">Specification</div>
  <div class="sbml-spec-title">{{ $spec.title }}</div>
  <div class="sbml-spec-authors">
    <span class="sbml-spec-authors-label">Authors: </span>
    {{ $spec.authors }}.
  </div>
  <div class="sbml-spec-description">
    This is {{ if ne $rel_text "" }}<strong>{{ $rel_text }}</strong> of {{ end }}
    the specification for SBML Level {{ $spec.level }} 
    Version {{ $spec.version }}, made available on {{ $spec.date }}.  
  </div>

  <div class="sbml-spec-link-box">
    <span class="sbml-spec-link">
      <a href="{{ $spec.pdf_main }}"><i class="fa-file-pdf fas fa-2x"></i><br>
        Specification</a>
    </span>
    {{ if and $spec.publication (ne $spec.publication "none") }}
    <span class="sbml-spec-link">
      <a href="{{ $spec.publication }}"><i class="fa-file-pdf fas fa-2x"></i><br>
        Publication</a>
    </span>
    {{ end }}
    {{ if and $spec.issues (ne $spec.issues "none") }}
    <span class="sbml-spec-link">
      <a href="{{ $spec.issues }}"><i class="fa-clipboard-list fas fa-2x"></i><br>
        Known issues</a>
    </span>
    {{ end }}
    {{ if $spec.tracker }}
    <span class="sbml-spec-link">
      <a href="{{ $spec.tracker }}"><i class="fa-bug fas fa-2x"></i><br>
        Report issue</a>
    </span>
    {{ end }}
    <span class="sbml-spec-link">
      <a href="{{ $spec.schema }}"><i class="fa-file-code fas fa-2x"></i><br>
        {{ $spec.schema_type }} schema</a>
    </span>
  </div>

  {{ if and $spec.publication (ne $spec.publication "none") }}
    <div class="sbml-spec-citation-box">
      <span class="sbml-spec-citation-label">How to cite the publication: </span>
      {{ $spec.citation | markdownify }}
      <span class="sbml-spec-citation-link">
        <a href="{{ $spec.cite_bibtex }}"><i class="fa-file-download fas fa-1x"></i> BibTeX</a>
      </span>
      <span class="sbml-spec-citation-link">
        <a href="{{ $spec.cite_ris }}"><i class="fa-file-download fas fa-1x"></i> RIS</a>
      </span>
    </div>
  {{ else if $spec.citation }}
    <div class="sbml-spec-citation-box">
      <span class="sbml-spec-citation-label">This specification does not have a true publication associated with it. You may cite this document as follows: </span>
      {{ $spec.citation | markdownify }}.
      <span class="sbml-spec-citation-link">
        <a href="{{ $spec.cite_bibtex }}"><i class="fa-file-download fas fa-1x"></i> BibTeX</a>
      </span>
      <span class="sbml-spec-citation-link">
        <a href="{{ $spec.cite_ris }}"><i class="fa-file-download fas fa-1x"></i> RIS</a>
      </span>
    </div>
  {{ end }}
</div>

